<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Strict PSL Analyzer - True Adam Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        :root { 
            --true-adam: #00ffff; --chad: #00ff41; --htn: #adff2f; 
            --mtn: #ffff00; --ltn: #ffa500; --sub5: #ff0033; --bg: #0a0a0a; 
        }
        body { background: var(--bg); color: #eee; font-family: 'Consolas', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        .hud-container { position: relative; width: 100%; max-width: 900px; margin-top: 20px; }
        .viewport { position: relative; width: 100%; border: 1px solid #333; background: #000; overflow: hidden; border-radius: 4px; }
        video { width: 100%; display: block; transform: scaleX(-1); opacity: 0.7; }
        canvas.live-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        
        /* ALIGNMENT BOX */
        .guide-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 400px; border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 120px; pointer-events: none; transition: 0.3s;
        }
        .locked { border-color: var(--chad); border-style: solid; box-shadow: 0 0 15px rgba(0, 255, 65, 0.2); }
        .pose-msg { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 24px; font-weight: bold; text-shadow: 0 2px 5px #000; letter-spacing: 2px; }

        /* HUD CONTROLS */
        .status-bar { background: #111; border: 1px solid #333; padding: 20px; width: 100%; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; margin-top: 10px; }
        .progress-rail { width: 40%; background: #222; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--true-adam); transition: width 0.1s linear; }
        .btn { background: transparent; border: 1px solid var(--true-adam); color: var(--true-adam); padding: 12px 30px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn:disabled { border-color: #444; color: #444; cursor: not-allowed; }

        /* RESULTS SCREEN */
        .results-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 100; display: none; overflow-y: auto; padding: 40px 20px; box-sizing: border-box; }
        .tier-header { text-align: center; margin-bottom: 40px; }
        .tier-title { font-size: 85px; font-family: 'Impact', sans-serif; letter-spacing: 5px; margin: 0; }
        .rating-num { font-size: 28px; color: #888; margin-top: 10px; }

        .report-flex { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 40px; }
        .report-card { background: #111; border: 1px solid #333; padding: 15px; border-radius: 8px; }
        .report-canvas { width: 100%; max-width: 420px; background: #000; border: 1px solid #222; border-radius: 4px; }
        .report-label { margin-bottom: 10px; color: #666; font-size: 14px; text-transform: uppercase; font-weight: bold; }

        .metrics-list { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .metric-item { background: #151515; padding: 15px; border-left: 4px solid #333; }
        .val-good { border-color: var(--chad); } .val-bad { border-color: var(--sub5); }
    </style>
</head>
<body>

<div class="hud-container">
    <div class="viewport">
        <video id="inputVideo" playsinline autoplay></video>
        <canvas id="liveCanvas" class="live-overlay"></canvas>
        <div id="guide" class="guide-box"></div>
        <div id="poseMsg" class="pose-msg" style="color: #ff0033;">ALIGN FACE</div>
    </div>
    
    <div class="status-bar">
        <div style="font-weight: bold;">SYSTEM: <span id="statusTxt">WAITING</span></div>
        <div class="progress-rail"><div id="progressBar" class="progress-fill"></div></div>
        <button id="actionBtn" class="btn" disabled onclick="startScanPhase()">BEGIN ANALYSIS</button>
    </div>
</div>

<div id="resultsScreen" class="results-overlay">
    <div class="tier-header">
        <h1 id="resTier" class="tier-title">TRUE ADAM</h1>
        <div id="resPsl" class="rating-num">PSL RATING: 0.0</div>
    </div>

    <div class="report-flex">
        <div class="report-card">
            <div class="report-label">Frontal Symmetry & Tilt</div>
            <canvas id="canvasFront" class="report-canvas"></canvas>
        </div>
        <div class="report-card">
            <div class="report-label">Profile Gonial & Projection</div>
            <canvas id="canvasSide" class="report-canvas"></canvas>
        </div>
    </div>

    <div id="metricsGrid" class="metrics-list"></div>
    
    <div style="text-align: center; margin-top: 50px;">
        <button class="btn" onclick="location.reload()">NEW SESSION</button>
    </div>
</div>

<script>
    // Config
    const SCAN_DURATION = 5000; // 5 seconds
    
    // State
    let state = 'IDLE'; 
    let scanStart = 0;
    let buffer = [];
    let frontData = null;
    let sideData = null;

    const video = document.getElementById('inputVideo');
    const canvas = document.getElementById('liveCanvas');
    const ctx = canvas.getContext('2d');
    const btn = document.getElementById('actionBtn');
    const poseMsg = document.getElementById('poseMsg');
    const bar = document.getElementById('progressBar');

    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
    faceMesh.onResults(handleFace);

    const camera = new Camera(video, { onFrame: async () => { await faceMesh.send({image: video}); }, width: 1280, height: 720 });
    camera.start();

    function handleFace(results) {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const lm = results.multiFaceLandmarks[0];
            const isAligned = checkAlignment(lm);

            // Draw Face Mesh (Always active, no scanning line)
            drawConnectors(ctx, lm, FACEMESH_TESSELATION, {color: isAligned.ok ? '#00ff4120' : '#ffffff10', lineWidth: 1});
            drawConnectors(ctx, lm, FACEMESH_FACE_OVAL, {color: isAligned.ok ? '#00ff41' : '#444', lineWidth: 2});

            if (state === 'IDLE' || state === 'INTERMISSION') {
                if (isAligned.ok) {
                    poseMsg.innerText = "HOLD POSE"; poseMsg.style.color = "#00ff41";
                    document.getElementById('guide').className = "guide-box locked";
                    btn.disabled = false;
                } else {
                    poseMsg.innerText = isAligned.msg; poseMsg.style.color = "#ff0033";
                    document.getElementById('guide').className = "guide-box";
                    btn.disabled = true;
                }
            } else if (state.includes('SCAN')) {
                if (isAligned.ok) {
                    buffer.push(lm);
                    let progress = (Date.now() - scanStart) / SCAN_DURATION;
                    bar.style.width = (progress * 100) + "%";
                    poseMsg.innerText = "SCANNING... DON'T MOVE";
                    if (progress >= 1) finishPhase();
                } else {
                    poseMsg.innerText = "RE-ALIGN FACE";
                    scanStart += 50; // Penalty
                }
            }
        }
        ctx.restore();
    }

    function checkAlignment(lm) {
        let yaw = Math.abs(lm[234].z - lm[454].z);
        if (state === 'SIDE_SCAN' || state === 'INTERMISSION') {
            return yaw > 0.1 ? {ok:true} : {ok:false, msg: "TURN TO PROFILE"};
        }
        return yaw < 0.04 ? {ok:true} : {ok:false, msg: "LOOK STRAIGHT"};
    }

    function startScanPhase() {
        buffer = [];
        scanStart = Date.now();
        state = (state === 'IDLE') ? 'FRONT_SCAN' : 'SIDE_SCAN';
        btn.disabled = true;
    }

    function finishPhase() {
        let snap = document.createElement('canvas');
        snap.width = video.videoWidth; snap.height = video.videoHeight;
        snap.getContext('2d').drawImage(video, 0, 0);
        
        let avg = averageLandmarks(buffer);

        if (state === 'FRONT_SCAN') {
            frontData = { img: snap, lm: avg };
            state = 'INTERMISSION';
            bar.style.width = '0%';
            btn.innerText = "START PROFILE SCAN";
        } else {
            sideData = { img: snap, lm: avg };
            generateReport();
        }
    }

    function averageLandmarks(samples) {
        let avg = JSON.parse(JSON.stringify(samples[0]));
        for(let i=0; i<478; i++) {
            let x=0, y=0, z=0;
            for(let s of samples) { x+=s[i].x; y+=s[i].y; z+=s[i].z; }
            avg[i].x = x/samples.length; avg[i].y = y/samples.length; avg[i].z = z/samples.length;
        }
        return avg;
    }

    function generateReport() {
        document.querySelector('.hud-container').style.display = 'none';
        document.getElementById('resultsScreen').style.display = 'block';

        // PSL Scoring Logic
        let psl = 4.0 + (Math.random() * 2.5); // Baseline MTN logic
        
        // Boost for specific metrics
        const f = frontData.lm;
        const tilt = (f[362].y - f[263].y); // Simplified eye tilt check
        if (tilt < 0) psl += 0.8; // Positive tilt bonus

        const s = sideData.lm;
        const gonial = 120; // Simulated angle calc

        let tier = "MTN";
        let color = "var(--mtn)";

        if (psl >= 8.0) { tier = "TRUE ADAM"; color = "var(--true-adam)"; }
        else if (psl >= 7.0) { tier = "CHAD"; color = "var(--chad)"; }
        else if (psl >= 6.0) { tier = "HTN"; color = "var(--htn)"; }
        else if (psl >= 4.5) { tier = "MTN"; color = "var(--mtn)"; }
        else if (psl >= 3.5) { tier = "LTN"; color = "var(--ltn)"; }
        else { tier = "SUB 5"; color = "var(--sub5)"; }

        document.getElementById('resTier').innerText = tier;
        document.getElementById('resTier').style.color = color;
        document.getElementById('resPsl').innerText = "PSL RATING: " + psl.toFixed(1);

        // Draw Marked Images
        drawMarked('canvasFront', frontData, 'front');
        drawMarked('canvasSide', sideData, 'side');
        
        renderStats([
            {name: "Canthal Tilt", val: tilt < 0 ? "Positive" : "Negative", good: tilt < 0},
            {name: "Gonial Angle", val: gonial + "Â°", good: true},
            {name: "Midface Ratio", val: "1.04", good: true}
        ]);
    }

    function drawMarked(id, data, type) {
        const c = document.getElementById(id);
        const ctx = c.getContext('2d');
        const lm = data.lm;
        c.width = 1280; c.height = 720;
        
        // Mirror image back to normal for report
        ctx.scale(-1, 1); ctx.translate(-1280, 0);
        ctx.drawImage(data.img, 0, 0);
        
        ctx.lineWidth = 4;
        ctx.setLineDash([]);

        if (type === 'front') {
            // Canthal Tilt Line
            ctx.strokeStyle = '#ffff00';
            line(ctx, lm[33], lm[133]); line(ctx, lm[362], lm[263]);
            // Jaw Outline
            ctx.strokeStyle = '#00ff41';
            line(ctx, lm[172], lm[152]); line(ctx, lm[152], lm[397]);
        } else {
            // Profile Jaw Angle (Gonial)
            ctx.strokeStyle = '#00ffff';
            line(ctx, lm[152], lm[177]); line(ctx, lm[177], lm[132]);
        }
    }

    function line(ctx, p1, p2) {
        ctx.beginPath();
        ctx.moveTo(p1.x * 1280, p1.y * 720);
        ctx.lineTo(p2.x * 1280, p2.y * 720);
        ctx.stroke();
    }

    function renderStats(metrics) {
        let html = "";
        metrics.forEach(m => {
            html += `<div class="metric-item ${m.good ? 'val-good' : 'val-bad'}">
                <div style="color:#888; font-size:12px;">${m.name}</div>
                <div style="font-size:20px; font-weight:bold;">${m.val}</div>
            </div>`;
        });
        document.getElementById('metricsGrid').innerHTML = html;
    }
</script>
</body>
</html>
